<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boberts Lumber Estimator AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #fff; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .chat-message-container { display: flex; flex-direction: column; }
        .chat-message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; line-height: 1.5; white-space: pre-wrap; }
        .user-message { background-color: #2d3748; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .model-message { background-color: #4a5568; color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 0; }
        .model-message h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #718096; }
        .model-message ul { list-style-type: none; padding-left: 0; margin-top: 0.5rem;}
        .model-message li { margin-bottom: 0.5rem; display: flex; justify-content: space-between; border-bottom: 1px solid #2d3748; padding-bottom: 0.5rem; }
        .model-message li:last-child { border-bottom: none; }
        .model-message li span:first-child { color: #cbd5e0; padding-right: 1rem; }
        .model-message li span:last-child { font-weight: 500; text-align: right; }
        .model-message strong { font-weight: 600; color: #ffffff; }
        .model-message p { margin-bottom: 1rem; }
        .model-message ol { list-style-type: decimal; padding-left: 1.5rem; }
        .model-message ol li { display: list-item; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Left Panel: Controls -->
        <div class="w-full md:w-1/2 lg:w-1/3 p-6 bg-gray-800/50 border-r border-gray-700 flex flex-col">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-white">Boberts Lumber Estimator AI</h1>
                <p class="text-gray-400 mt-1">Generate a material list and chat with the AI for follow-ups.</p>
            </header>

            <div class="flex-grow flex flex-col space-y-4">
                <!-- API Key Input -->
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Enter Your Google API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="Paste your API key here">
                </div>
                
                <!-- File Upload -->
                <div>
                    <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-1">Upload Architectural Plans (PDF)</label>
                    <div class="mt-1 flex items-center space-x-2">
                        <label for="file-upload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                            Choose File
                        </label>
                        <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".pdf">
                        <span id="file-name" class="text-sm text-gray-400 truncate">No file selected...</span>
                    </div>
                </div>

                <!-- Prompt -->
                <div>
                    <label for="prompt-input" class="block text-sm font-medium text-gray-300 mb-1">Initial Prompt for Takeoff</label>
                    <textarea id="prompt-input" rows="18" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"></textarea>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="mt-6">
                <button id="generate-btn" class="w-full flex justify-center items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 disabled:bg-blue-800 disabled:cursor-not-allowed">
                    <span id="btn-text">Generate & Start Chat</span>
                    <div id="spinner" class="spinner hidden ml-3"></div>
                </button>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="w-full md:w-1/2 lg:w-2/3 p-6 md:p-8 flex flex-col h-screen">
            <div id="chat-container" class="flex-grow overflow-y-auto mb-4 pr-2">
                <div id="placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                    <svg class="w-16 h-16 mb-4" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.76 9.76 0 01-2.53-.401m-1.009-9.195a21.035 21.035 0 01-2.134-2.333m5.345-2.333a21.035 21.035 0 00-2.134 2.333m-2.134 2.333a21.035 21.035 0 00-2.333 2.134m2.333 2.134a21.035 21.035 0 012.134 2.333M12 3c4.97 0 9 3.694 9 8.25s-4.03 8.25-9 8.25S3 17.556 3 13c0-4.556 4.03-8.25 9-8.25z" /></svg>
                    <h2 class="text-xl font-semibold">Your conversation will appear here.</h2>
                    <p class="mt-1">Generate the initial estimate to begin your chat.</p>
                </div>
            </div>
            <div id="chat-input-container" class="flex items-center space-x-2">
                <textarea id="chat-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none" placeholder="Ask a follow-up question..." disabled rows="1"></textarea>
                <button id="chat-send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-md transition-colors duration-200 disabled:bg-blue-800 disabled:cursor-not-allowed self-end" disabled>
                    <svg class="w-6 h-6" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const apiKeyInput = document.getElementById('api-key-input');
        const fileUpload = document.getElementById('file-upload');
        const fileNameSpan = document.getElementById('file-name');
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');
        const chatContainer = document.getElementById('chat-container');
        const placeholder = document.getElementById('placeholder');
        const chatInputContainer = document.getElementById('chat-input-container');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        let fileBase64 = null;
        let fileMimeType = null;
        let chatHistory = [];
        
        const promptTemplate = `# Role
You are a senior Lumber and Materials Estimator. Your task is to perform a detailed, multi-stage material takeoff from architectural plans.
# Primary Task
Create a complete and accurate material list formatted as a point-form quote package. The estimate must be comprehensive, covering all stages of construction from the foundation to the finishes, based on the provided plans and the specific calculation rules below.
# Calculation Rules & Methodology
1. Framing:
- First Floor Exterior Wall Studs: Calculate using 1 stud per linear foot of the wall. Determine stud length from elevation/section drawings.
- Gable-End Wall Studs: For second-floor gables, calculate the quantity of studs based on 16" on-center spacing across the building's width. The stud length must be based on the peak height of the gable, calculated from the elevation drawings (peak height minus the second-floor deck height).
- Interior Wall Studs: Calculate based on measurements from the floor plan, assuming 1 stud per linear foot.
- Wall Plates: Calculate for all walls using the formula: (Total Linear Footage of Walls x 3) / 16 feet.
- Subfloor: Only calculate for wood-framed floor systems (like the second floor). Do not calculate for a concrete slab-on-grade first floor.
2. Siding & Exterior Trim:
- Siding Area: Calculate the total exterior wall surface area, including the triangular gable ends.
- Siding Pieces: Based on the siding area, calculate the total number of pieces needed using the dimensions I provide (e.g., 8" x 12'). Add a 15% waste factor to the final piece count.
- Trim: Quantify all trim pieces:
    - Starter Strip & Fascia/Soffit/Gutters: Based on the linear footage of the eaves.
    - J-Channel: Based on the perimeter of all windows, doors, and roof rakes.
    - Corner Posts: Based on a physical count of inside and outside corners from the floor plan.
3. Roofing:
- Roofing Materials (Shingles, Sheathing, Eaves Guard): Calculate based on the total roof surface area.
- Shingles: Use the specific coverage rate I provide (e.g., 1 bundle covers 32 sq ft) and add a 15% waste factor.
- Drip Edge: Calculate based on the total perimeter of the roof (eaves + rakes).
# Output Format
- The final output must be a single, consolidated, point-form list.
- Organize the list into the following exact categories:
    1. Foundation & Site Work
    2. First Floor Materials
    3. Second Floor Materials
    4. Exterior Envelope & Roofing
    5. Mechanical & Electrical Systems
- Every line item must have a specific quantity (e.g., "85 EA", "26 Sheets", "455 sq ft"). Use "1 Lot" only for complex systems like plumbing pipes or electrical wiring.
- Include a standard disclaimer at the end regarding labor, taxes, and the need for on-site verification by the builder.
# Critical Instructions (To Avoid Back-and-Forth)
- Initial Review: Before providing the final quote, perform a quick review of the plans.
- Ask Clarifying Questions: If you find missing dimensions (like wall heights), conflicting information (like a lintel schedule that contradicts a simple instruction), or unclear details, you MUST ask me targeted questions first before proceeding.
- Acknowledge All Details: Pay close attention to specific callouts in the plans, such as ZIP system sheathing, radon barriers, insulation types (spray foam vs. batt), and engineered beams (LVLs), and ensure they are included in the list.`;
        promptInput.value = promptTemplate;

        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onloadend = () => {
                    fileBase64 = reader.result.split(',')[1];
                    fileMimeType = file.type;
                };
                reader.readAsDataURL(file);
            } else {
                fileNameSpan.textContent = 'No file selected...';
                fileBase64 = null;
            }
        });

        generateBtn.addEventListener('click', async () => {
            if (!apiKeyInput.value.trim()) { return displayError("Please enter your Google API key first."); }
            if (!fileBase64) { return displayError("Please upload a PDF file."); }
            if (!promptInput.value.trim()) { return displayError("Please provide an initial prompt."); }

            setLoading(true, 'generate');
            chatHistory = []; // Reset history for new project
            chatContainer.innerHTML = ''; // Clear chat
            placeholder.classList.add('hidden');

            const initialUserMessage = {
                role: "user",
                parts: [
                    { text: promptInput.value },
                    { inlineData: { mimeType: fileMimeType, data: fileBase64 } }
                ]
            };
            chatHistory.push(initialUserMessage);

            try {
                const resultText = await callApi();
                chatHistory.push({ role: "model", parts: [{ text: resultText }] });
                appendMessage('model', resultText);
                enableChatInput();
            } catch (error) {
                console.error("API Call Error:", error);
                displayError(`An error occurred: ${error.message}.`);
            } finally {
                setLoading(false, 'generate');
            }
        });

        chatSendBtn.addEventListener('click', handleChatSend);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line on simple Enter
                handleChatSend();
            }
        });
        
        chatInput.addEventListener('input', () => {
            // Auto-resize textarea
            chatInput.style.height = 'auto';
            chatInput.style.height = (chatInput.scrollHeight) + 'px';
        });

        async function handleChatSend() {
            const message = chatInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            chatInput.value = '';
            chatInput.style.height = 'auto'; // Reset height
            setLoading(true, 'chat');

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            try {
                const resultText = await callApi();
                chatHistory.push({ role: "model", parts: [{ text: resultText }] });
                appendMessage('model', resultText);
            } catch (error) {
                console.error("API Call Error:", error);
                appendMessage('model', `Sorry, an error occurred: ${error.message}`);
            } finally {
                setLoading(false, 'chat');
            }
        }

        async function callApi() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) throw new Error("API Key is missing.");
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: chatHistory };

            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            if (result.promptFeedback?.blockReason) {
                                throw new Error(`Request was blocked. Reason: ${result.promptFeedback.blockReason}`);
                            }
                            throw new Error("Invalid response structure from API.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        console.warn(`Request failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error?.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                }
            }
            throw new Error("API request failed after multiple retries.");
        }

        function setLoading(isLoading, type) {
            if (type === 'generate') {
                generateBtn.disabled = isLoading;
                btnText.textContent = isLoading ? 'Generating...' : 'Generate & Start Chat';
                spinner.classList.toggle('hidden', !isLoading);
            } else if (type === 'chat') {
                chatInput.disabled = isLoading;
                chatSendBtn.disabled = isLoading;
            }
        }

        function displayError(message) {
            placeholder.classList.remove('hidden');
            chatContainer.innerHTML = '';
            placeholder.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center text-red-400">
                <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                <h2 class="text-xl font-semibold">An Error Occurred</h2><p class="mt-1">${message}</p></div>`;
        }

        function appendMessage(role, text) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'chat-message-container';
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${role === 'user' ? 'user-message' : 'model-message'}`;
            
            if (role === 'model') {
                messageElement.innerHTML = markdownToHtml(text);
            } else {
                messageElement.textContent = text;
            }
            
            messageContainer.appendChild(messageElement);
            chatContainer.appendChild(messageContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function enableChatInput() {
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
        }

        function markdownToHtml(md) {
            let html = md;
            // Process headers and bold
            html = html.replace(/^###\s+(.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Process list items
            const lines = html.split('\n');
            let inList = false;
            const processedLines = lines.map(line => {
                if (line.startsWith('* ')) {
                    const content = line.substring(2);
                    const parts = content.split(':');
                    if (parts.length > 1) {
                        return `<li><span>${parts[0].trim()}:</span> <span>${parts.slice(1).join(':').trim()}</span></li>`;
                    }
                    return `<li><span>${content}</span></li>`;
                }
                return line;
            });

            // Wrap consecutive list items in a single <ul>
            let finalHtml = '';
            for (let i = 0; i < processedLines.length; i++) {
                const line = processedLines[i];
                const isListItem = line.trim().startsWith('<li>');
                if (isListItem && !inList) {
                    finalHtml += '<ul>';
                    inList = true;
                }
                if (!isListItem && inList) {
                    finalHtml += '</ul>';
                    inList = false;
                }
                finalHtml += line + '\n';
            }
            if (inList) {
                finalHtml += '</ul>';
            }
            
            // Process disclaimer
            finalHtml = finalHtml.replace(/^(Disclaimer:.*$)/gim, '<p class="text-sm text-gray-500 mt-6 italic">$1</p>');

            return finalHtml;
        }

    </script>
</body>
</html>

